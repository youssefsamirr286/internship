//USERS table
ALTER TABLE PROJECT.USERS
 DROP PRIMARY KEY CASCADE;

DROP TABLE PROJECT.USERS CASCADE CONSTRAINTS;

CREATE TABLE PROJECT.USERS
(
  USER_ID    NUMBER,
  FULL_NAME  VARCHAR2(120 BYTE)                 NOT NULL,
  EMAIL      VARCHAR2(160 BYTE)                 NOT NULL,
  PASSWORD   VARCHAR2(200 BYTE)                 NOT NULL,
  INCOME     NUMBER(15,2)                       NOT NULL,
  EXPENSES   NUMBER(15,2)                       DEFAULT 0                     NOT NULL
)
TABLESPACE USERS
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
MONITORING;


--  There is no statement for index PROJECT.SYS_C007229.
--  The object is created when the parent object is created.

CREATE OR REPLACE TRIGGER PROJECT.TRG_USERS_BI
BEFORE INSERT ON PROJECT.USERS
FOR EACH ROW
BEGIN
  IF :NEW.USER_ID IS NULL THEN
    SELECT SEQ_USERS.NEXTVAL INTO :NEW.USER_ID FROM dual;
  END IF;
END;
/


ALTER TABLE PROJECT.USERS ADD (
  PRIMARY KEY
  (USER_ID)
  USING INDEX
    TABLESPACE USERS
    PCTFREE    10
    INITRANS   2
    MAXTRANS   255
    STORAGE    (
                INITIAL          64K
                NEXT             1M
                MINEXTENTS       1
                MAXEXTENTS       UNLIMITED
                PCTINCREASE      0
                BUFFER_POOL      DEFAULT
               )
  ENABLE VALIDATE);

//TXN table
ALTER TABLE PROJECT.TXN
 DROP PRIMARY KEY CASCADE;

DROP TABLE PROJECT.TXN CASCADE CONSTRAINTS;

CREATE TABLE PROJECT.TXN
(
  TXN_ID       NUMBER                           NOT NULL,
  USER_ID      NUMBER                           NOT NULL,
  CATEGORY_ID  NUMBER                           NOT NULL,
  AMOUNT       FLOAT(53)                        NOT NULL,
  TYPE         VARCHAR2(10 BYTE)                NOT NULL,
  TXN_DATE     DATE                             DEFAULT NULL,
  ID           NUMBER(19)                       NOT NULL
)
TABLESPACE USERS
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
MONITORING;


CREATE UNIQUE INDEX PROJECT.PK_TXN ON PROJECT.TXN
(TXN_ID)
LOGGING
TABLESPACE USERS
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

CREATE OR REPLACE TRIGGER PROJECT.TRG_TXN_BI
BEFORE INSERT ON PROJECT.TXN
FOR EACH ROW
BEGIN
  IF :NEW.TXN_ID IS NULL THEN
    SELECT SEQ_TXN.NEXTVAL INTO :NEW.TXN_ID FROM dual;
  END IF;
END;
/


ALTER TABLE PROJECT.TXN ADD (
  CHECK (AMOUNT > 0)
  ENABLE VALIDATE,
  CHECK (TYPE IN ('INCOME','EXPENSE'))
  ENABLE VALIDATE,
  CONSTRAINT PK_TXN
  PRIMARY KEY
  (TXN_ID)
  USING INDEX PROJECT.PK_TXN
  ENABLE VALIDATE);

ALTER TABLE PROJECT.TXN ADD (
  CONSTRAINT FKKH2QJSIYV6VCQ301XPWXMYHA5 
  FOREIGN KEY (CATEGORY_ID) 
  REFERENCES PROJECT.CATEGORY (CATEGORY_ID)
  ENABLE VALIDATE,
  CONSTRAINT FK_TXN_USER 
  FOREIGN KEY (USER_ID) 
  REFERENCES PROJECT.USERS_OLD (USER_ID)
  ON DELETE CASCADE
  ENABLE VALIDATE);

//CATEGORY table
ALTER TABLE PROJECT.CATEGORY
 DROP PRIMARY KEY CASCADE;

DROP TABLE PROJECT.CATEGORY CASCADE CONSTRAINTS;

CREATE TABLE PROJECT.CATEGORY
(
  CATEGORY_ID  NUMBER                           NOT NULL,
  USER_ID      NUMBER                           NOT NULL,
  NAME         VARCHAR2(80 BYTE)                NOT NULL,
  ID           NUMBER(19)                       NOT NULL
)
TABLESPACE USERS
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
MONITORING;


CREATE UNIQUE INDEX PROJECT.PK_CATEGORY ON PROJECT.CATEGORY
(CATEGORY_ID)
LOGGING
TABLESPACE USERS
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

CREATE UNIQUE INDEX PROJECT.UQ_CAT ON PROJECT.CATEGORY
(USER_ID, NAME)
LOGGING
TABLESPACE USERS
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

CREATE OR REPLACE TRIGGER PROJECT.TRG_CATEGORY_BI
BEFORE INSERT ON PROJECT.CATEGORY
FOR EACH ROW
BEGIN
  IF :NEW.CATEGORY_ID IS NULL THEN
    SELECT SEQ_CATEGORY.NEXTVAL INTO :NEW.CATEGORY_ID FROM dual;
  END IF;
END;
/


ALTER TABLE PROJECT.CATEGORY ADD (
  CONSTRAINT PK_CATEGORY
  PRIMARY KEY
  (CATEGORY_ID)
  USING INDEX PROJECT.PK_CATEGORY
  ENABLE VALIDATE,
  CONSTRAINT UQ_CAT
  UNIQUE (USER_ID, NAME)
  USING INDEX PROJECT.UQ_CAT
  ENABLE VALIDATE);

ALTER TABLE PROJECT.CATEGORY ADD (
  CONSTRAINT FK_CATEGORY_USER 
  FOREIGN KEY (USER_ID) 
  REFERENCES PROJECT.USERS_OLD (USER_ID)
  ON DELETE CASCADE
  ENABLE VALIDATE);

